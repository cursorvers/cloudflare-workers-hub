name = "orchestrator-hub"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# Workers AI binding
[ai]
binding = "AI"

# D1 Database for Knowledge Base
[[d1_databases]]
binding = "DB"
database_name = "knowledge-base"
database_id = "4164f0fc-d6bb-4e78-86d1-2601d762d6de"

# KV Namespace for caching
[[kv_namespaces]]
binding = "CACHE"
id = "378a478680ec41d280737181530f58a9"

# Durable Objects for atomic task queue coordination
[durable_objects]
bindings = [
  { name = "TASK_COORDINATOR", class_name = "TaskCoordinator" },
  { name = "COCKPIT_WS", class_name = "CockpitWebSocket" }
]

# DO migration (required for first deployment, free plan requires new_sqlite_classes)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["TaskCoordinator"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["CockpitWebSocket"]

# R2 bucket for audio staging and Obsidian vault (requires R2 enabled on account)
# [[r2_buckets]]
# binding = "AUDIO_STAGING"
# bucket_name = "voice-messages"

# [[r2_buckets]]
# binding = "OBSIDIAN_VAULT"
# bucket_name = "obsidian-vault"

# Vectorize for semantic search
[[vectorize]]
binding = "KNOWLEDGE_INDEX"
index_name = "obsidian-knowledge"

# Cron Triggers
[triggers]
crons = ["0 * * * *", "0 21 * * *", "0 0 * * SUN", "0 0 1 * *", "0 0 2 1 *"]  # Hourly sync, Daily actions (6AM JST), Weekly digest (Sun 9AM JST), Monthly digest (1st 9AM JST), Annual digest (Jan 2nd 9AM JST)

# Environment variables
[vars]
ENVIRONMENT = "development"
LIMITLESS_AUTO_SYNC_ENABLED = "true"
LIMITLESS_USER_ID = "masayuki"
LIMITLESS_SYNC_INTERVAL_HOURS = "1"
# Cloudflare Access (Zero Trust)
CF_ACCESS_TEAM = "masa-stage1"
# CF_ACCESS_AUD is set via wrangler secret

# Development settings
[dev]
port = 8787
local_protocol = "http"

# Production environment
[env.production]
vars = { ENVIRONMENT = "production", CF_ACCESS_TEAM = "masa-stage1" }
# CF_ACCESS_AUD should be set via wrangler secret or dashboard after Access app creation

[env.production.ai]
binding = "AI"

[[env.production.d1_databases]]
binding = "DB"
database_name = "knowledge-base"
database_id = "4164f0fc-d6bb-4e78-86d1-2601d762d6de"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "378a478680ec41d280737181530f58a9"

[env.production.durable_objects]
bindings = [
  { name = "TASK_COORDINATOR", class_name = "TaskCoordinator" },
  { name = "COCKPIT_WS", class_name = "CockpitWebSocket" }
]

# [[env.production.r2_buckets]]
# binding = "AUDIO_STAGING"
# bucket_name = "voice-messages"

# [[env.production.r2_buckets]]
# binding = "OBSIDIAN_VAULT"
# bucket_name = "obsidian-vault"

[[env.production.vectorize]]
binding = "KNOWLEDGE_INDEX"
index_name = "obsidian-knowledge"
